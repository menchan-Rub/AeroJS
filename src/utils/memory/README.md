# AeroJS メモリ管理システム

## 概要

AeroJSエンジンのメモリ管理システムは、高性能で安全なメモリ割り当て、ガベージコレクション、リソース追跡を提供します。JavaScriptオブジェクトのライフサイクル管理と効率的なメモリ利用を実現するための基盤です。

## 主要コンポーネント

### アロケータ

- **MemoryAllocator**: メモリアロケーションの基本インターフェース
- **BumpAllocator**: 単純で高速なバンプポインタアロケーション
- **RegionAllocator**: リージョンベースのメモリ管理
- **PoolAllocator**: 固定サイズオブジェクト用のプールアロケーション

### ガベージコレクション

- **GarbageCollector**: 未使用オブジェクトの検出と回収
- **Marker**: 到達可能オブジェクトの識別
- **Sweeper**: 未使用メモリの回収
- **WriteBarrier**: 世代間参照の追跡

### スマートポインタ

- **SharedPtr**: 共有所有権を表現するスマートポインタ
- **UniquePtr**: 排他的所有権を表現するスマートポインタ
- **WeakPtr**: 所有権なしの弱参照
- **WeakHandle**: GC対応の弱参照

### オブジェクトプール

- **ObjectPool**: 同じ型のオブジェクト用プール
- **PoolManager**: 複数プールの管理
- **SlabAllocator**: スラブアロケーションによるプーリング

## ガベージコレクションアルゴリズム

AeroJSは世代別マーク・スイープGCを採用しています：

1. **ヤングジェネレーション**: 新しいオブジェクト用の小さく高速なGC
2. **オールドジェネレーション**: 長寿命オブジェクト用の大きなGC
3. **マーキングフェーズ**: 到達可能オブジェクトを識別
4. **スイーピングフェーズ**: 未使用オブジェクトを回収
5. **コンパクションフェーズ**: （オプション）メモリフラグメント解消

## 弱参照システム

GCと統合された弱参照システムにより、オブジェクトの寿命を尊重しつつ参照を維持できます：

- **WeakPtr**: 基本的な弱参照
- **WeakHandle**: ハンドルベースの弱参照
- **FinalizationRegistry**: オブジェクト解放後の処理

## GCチューニング

ガベージコレクションのパフォーマンスを最適化するパラメータ：

- **GCしきい値**: コレクションをトリガーするメモリ使用率
- **ジェネレーションサイズ**: 各世代のサイズ比率
- **GC間隔**: コレクションの頻度
- **GCヒューリスティック**: アロケーションパターンに基づく調整

## メモリプロファイリング

メモリ使用状況を分析するための機能：

- **メモリ統計**: 割り当てと解放の統計情報
- **リークトラッキング**: メモリリークの検出
- **割り当てトレース**: オブジェクト割り当ての追跡
- **GCイベントログ**: ガベージコレクションイベントの記録

## 使用方法

```cpp
// アロケータの使用例
MemoryAllocator* allocator = engine->getMemoryAllocator();
void* memory = allocator->allocate(1024);  // 1024バイト割り当て
allocator->deallocate(memory);

// スマートポインタの使用例
SharedPtr<Object> obj = MakeShared<Object>(allocator);
obj->setProperty("key", "value");

// 弱参照の使用例
WeakHandle<Object> weakRef = engine->createWeakHandle(obj.get());
if (Object* ptr = weakRef.get()) {
    // オブジェクトがまだ生存している
}

// GC制御
engine->collectGarbage();  // 明示的なGC実行
```

## サブディレクトリ

- **`allocators/`**: 各種メモリアロケータ実装
- **`gc/`**: ガベージコレクタ実装
- **`pool/`**: オブジェクトプール実装
- **`smart_ptr/`**: スマートポインタ実装 