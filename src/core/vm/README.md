# AeroJS バーチャルマシン

## 概要

AeroJSバーチャルマシン（VM）は、JavaScriptコードの実行エンジンの中核部分です。バイトコードインタープリタ、スタックマシン、呼び出し規約、例外処理メカニズムなどを提供し、高速で安定したJavaScript実行を実現します。

## 主要コンポーネント

### バイトコードインタープリタ

- **命令セット**: JavaScript命令をエンコードするバイトコード命令群
- **ディスパッチループ**: バイトコード命令の連続実行
- **実行コンテキスト**: 現在の実行環境の維持と管理

### スタックマシン

- **評価スタック**: 計算中の値を保持するスタック
- **コールスタック**: 関数呼び出しフレームを管理するスタック
- **スタックオペレーション**: プッシュ、ポップ、ピークなどの操作

### 関数呼び出し

- **呼び出し規約**: 引数の受け渡しと戻り値の処理
- **this束縛**: JavaScriptの特殊なthis参照の処理
- **クロージャ**: レキシカルスコープを保持した関数の実装

### 例外処理

- **try/catch/finally**: JavaScript例外処理構文のサポート
- **スタックアンワインド**: 例外発生時のスタックフレーム巻き戻し
- **エラーオブジェクト**: 標準エラー型のサポート

## バイトコード設計

VMは効率的なバイトコード命令セットを使用し、以下の原則に基づいています：

1. **単純性**: 各命令は一つの明確な操作を実行
2. **効率性**: 頻繁な操作は特化された命令で最適化
3. **拡張性**: 将来の拡張に対応できる柔軟な設計

主なバイトコード命令カテゴリ：

- **ロード/ストア**: 変数の読み書き
- **算術/論理**: 数値演算、比較、ビット操作
- **オブジェクト操作**: プロパティアクセス、メソッド呼び出し
- **フロー制御**: 分岐、ループ、関数呼び出し
- **例外処理**: try/catch/finallyブロック

## JITインテグレーション

VMはJITコンパイラとシームレスに統合し、動的な最適化を実現します：

- **プロファイリングサポート**: 型情報と実行頻度の収集
- **ホットスワップ**: インタープリタコードとJITコード間の切り替え
- **デオプティマイズ**: 型推測が外れた場合のフォールバック

## 最適化技術

- **インラインキャッシュ**: 繰り返しのプロパティアクセスを最適化
- **型特化**: 特定の型に対する最適化された実行経路
- **命令合成**: 頻出パターンの複合命令化

## 実装状況

- ✅ バイトコードインタープリタ: 実装済み
- ✅ スタックマシン: 実装済み
- ✅ 呼び出し規約: 実装済み
- ✅ 例外処理メカニズム: 実装済み
- ✅ JITとの統合: 基本実装済み
- ✅ インラインキャッシュ: 実装済み

## サブディレクトリ

- **`bytecode/`**: バイトコード定義と生成
- **`interpreter/`**: バイトコードインタープリタ
- **`stack/`**: スタック管理
- **`calling/`**: 関数呼び出し管理
- **`exception/`**: 例外処理メカニズム 