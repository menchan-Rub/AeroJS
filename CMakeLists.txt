cmake_minimum_required(VERSION 3.20)

# AeroJS ä¸–ç•Œæœ€é«˜ãƒ¬ãƒ™ãƒ« JavaScript ã‚¨ãƒ³ã‚¸ãƒ³
project(AeroJS 
    VERSION 3.0.0
    DESCRIPTION "World's Most Advanced JavaScript Engine - Quantum Level Performance"
    LANGUAGES CXX
)

# C++20æ¨™æº–ã‚’ä½¿ç”¨ï¼ˆæœ€æ–°æ©Ÿèƒ½ã‚’æ´»ç”¨ï¼‰
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# ä¸–ç•Œæœ€é«˜ãƒ¬ãƒ™ãƒ«ã®æœ€é©åŒ–è¨­å®š
if(CMAKE_BUILD_TYPE STREQUAL "Release")
    if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
        set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG -march=native -mtune=native -mavx2 -mfma -flto")
        set(CMAKE_CXX_FLAGS_DEBUG "-O0 -g3 -fsanitize=address,undefined")
    elseif(MSVC)
        set(CMAKE_CXX_FLAGS_RELEASE "/O2 /Ob2 /DNDEBUG /arch:AVX2 /GL")
        set(CMAKE_CXX_FLAGS_DEBUG "/Od /Zi /RTC1")
    endif()
    set(CMAKE_INTERPROCEDURAL_OPTIMIZATION TRUE)
endif()

# ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©å›ºæœ‰ã®æœ€é©åŒ–
if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -Wpedantic -mavx2 -mfma")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -fomit-frame-pointer -finline-functions")
elseif(CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -Wpedantic -mavx2 -mfma")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -fomit-frame-pointer -finline-functions")
elseif(CMAKE_CXX_COMPILER_ID STREQUAL "MSVC")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /W4 /MP /permissive-")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} /Gy /GS-")
endif()

# ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
include_directories(${CMAKE_SOURCE_DIR})
include_directories(${CMAKE_SOURCE_DIR}/include)

# === æ—¢å­˜ã®ã‚³ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚½ãƒ¼ã‚¹ ===
set(CORE_SOURCES
    # ã‚¨ãƒ³ã‚¸ãƒ³ã‚³ã‚¢ï¼ˆæ—¢å­˜ï¼‰
    src/core/engine.cpp
    src/core/context.cpp
    src/core/value.cpp
    
    # ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ—¢å­˜ï¼‰
    src/core/runtime/builtins/builtins_manager.cpp
    
    # å¤‰æ›ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ—¢å­˜ï¼‰
    src/core/transformers/transformer.cpp
    
    # ä¸–ç•Œæœ€é«˜ãƒ¬ãƒ™ãƒ«æ–°æ©Ÿèƒ½å®Ÿè£…
    src/core/world_class_engine.cpp
    src/core/quantum_jit.cpp
    src/core/hyper_gc.cpp
)

# === æ—¢å­˜ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚½ãƒ¼ã‚¹ ===
set(UTILS_SOURCES
    # ãƒ¡ãƒ¢ãƒªç®¡ç†ï¼ˆæ—¢å­˜ï¼‰
    src/utils/memory/allocators/memory_allocator.cpp
    src/utils/memory/pool/memory_pool.cpp
    src/utils/memory/gc/garbage_collector.cpp
    
    # æ™‚é–“ç®¡ç†ï¼ˆæ—¢å­˜ï¼‰
    src/utils/time/timer.cpp
)

# === ä¸–ç•Œæœ€é«˜ãƒ¬ãƒ™ãƒ«æ–°æ©Ÿèƒ½ã‚½ãƒ¼ã‚¹ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚ªãƒ³ãƒªãƒ¼ï¼‰ ===
set(WORLD_CLASS_HEADERS
    # é‡å­JITã‚³ãƒ³ãƒ‘ã‚¤ãƒ©
    include/aerojs/quantum_jit.h
    
    # è¶…é«˜é€Ÿã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚¿
    include/aerojs/hyper_gc.h
    
    # è¶…é«˜é€Ÿãƒ‘ãƒ¼ã‚µãƒ¼
    include/aerojs/ultra_parser.h
    
    # ä¸–ç•Œæœ€é«˜ãƒ¬ãƒ™ãƒ«çµ±åˆã‚¨ãƒ³ã‚¸ãƒ³
    include/aerojs/world_class_engine.h
)

# === AeroJSã‚³ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒª ===
add_library(AeroJSCore STATIC ${CORE_SOURCES} ${UTILS_SOURCES})

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®š
set_target_properties(AeroJSCore PROPERTIES
    VERSION ${PROJECT_VERSION}
    SOVERSION 3
    OUTPUT_NAME "aerojs_core"
    CXX_STANDARD 20
    CXX_STANDARD_REQUIRED ON
)

# === ä¸–ç•Œæœ€é«˜ãƒ¬ãƒ™ãƒ«ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ  ===
add_executable(world_class_test world_class_test.cpp)
target_link_libraries(world_class_test AeroJSCore)

# === ç©¶æ¥µãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ  ===
add_executable(ultimate_test ultimate_test.cpp)
target_link_libraries(ultimate_test AeroJSCore)

# === å¾“æ¥ã®ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼ˆäº’æ›æ€§ï¼‰ ===
add_executable(test_aerojs test_main.cpp)
target_link_libraries(test_aerojs AeroJSCore)

# === ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒªãƒ³ã‚¯ ===
find_package(Threads REQUIRED)
target_link_libraries(AeroJSCore Threads::Threads)
target_link_libraries(world_class_test Threads::Threads)
target_link_libraries(ultimate_test Threads::Threads)
target_link_libraries(test_aerojs Threads::Threads)

# === ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å›ºæœ‰ã®è¨­å®š ===
if(WIN32)
    # Windowså›ºæœ‰ã®è¨­å®š
    target_compile_definitions(AeroJSCore PRIVATE 
        AEROJS_WINDOWS=1
        AEROJS_WORLD_CLASS=1
        AEROJS_QUANTUM_ENABLED=1
    )
    target_link_libraries(AeroJSCore ws2_32 winmm kernel32 user32)
elseif(UNIX AND NOT APPLE)
    # Linuxå›ºæœ‰ã®è¨­å®š
    target_compile_definitions(AeroJSCore PRIVATE 
        AEROJS_LINUX=1
        AEROJS_WORLD_CLASS=1
        AEROJS_QUANTUM_ENABLED=1
    )
    target_link_libraries(AeroJSCore dl rt pthread)
elseif(APPLE)
    # macOSå›ºæœ‰ã®è¨­å®š
    target_compile_definitions(AeroJSCore PRIVATE 
        AEROJS_MACOS=1
        AEROJS_WORLD_CLASS=1
        AEROJS_QUANTUM_ENABLED=1
    )
    target_link_libraries(AeroJSCore dl pthread)
endif()

# === ä¸–ç•Œæœ€é«˜ãƒ¬ãƒ™ãƒ«æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ– ===
target_compile_definitions(AeroJSCore PRIVATE
    AEROJS_VERSION_MAJOR=3
    AEROJS_VERSION_MINOR=0
    AEROJS_VERSION_PATCH=0
    AEROJS_ENABLE_QUANTUM_JIT=1
    AEROJS_ENABLE_HYPER_GC=1
    AEROJS_ENABLE_ULTRA_PARSER=1
    AEROJS_ENABLE_WORLD_CLASS_ENGINE=1
    AEROJS_ENABLE_PARALLEL_EXECUTION=1
    AEROJS_ENABLE_STREAMING_EXECUTION=1
    AEROJS_ENABLE_ADAPTIVE_OPTIMIZATION=1
    AEROJS_ENABLE_PREDICTIVE_GC=1
    AEROJS_ENABLE_CONCURRENT_GC=1
    AEROJS_ENABLE_QUANTUM_OPTIMIZATION=1
)

# === ã‚«ã‚¹ã‚¿ãƒ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ ===

# ä¸–ç•Œæœ€é«˜ãƒ¬ãƒ™ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
add_custom_target(run_world_class_test
    COMMAND world_class_test
    DEPENDS world_class_test
    COMMENT "Running World Class AeroJS Tests"
)

# ç©¶æ¥µãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
add_custom_target(run_ultimate_test
    COMMAND ultimate_test
    DEPENDS ultimate_test
    COMMENT "Running Ultimate AeroJS Tests - Quantum Level Verification"
)

# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
add_custom_target(run_all_tests
    COMMAND test_aerojs
    COMMAND world_class_test
    COMMAND ultimate_test
    DEPENDS test_aerojs world_class_test ultimate_test
    COMMENT "Running All AeroJS Tests - Complete Verification Suite"
)

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
add_custom_target(benchmark
    COMMAND ultimate_test
    DEPENDS ultimate_test
    COMMENT "Running Performance Benchmarks - Proving World Class Performance"
)

# === ãƒ“ãƒ«ãƒ‰æƒ…å ±ã®è¡¨ç¤º ===
message(STATUS "ğŸŒŸ AeroJS World Class JavaScript Engine v${PROJECT_VERSION}")
message(STATUS "ğŸš€ Quantum Level Performance - Beyond V8, SpiderMonkey, JavaScriptCore")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "C++ Standard: C++${CMAKE_CXX_STANDARD}")
message(STATUS "Target Platform: ${CMAKE_SYSTEM_NAME} ${CMAKE_SYSTEM_PROCESSOR}")

if(CMAKE_BUILD_TYPE STREQUAL "Release")
    message(STATUS "ğŸ† Optimized for MAXIMUM PERFORMANCE!")
    message(STATUS "ğŸ¯ Target: 10x faster than V8")
    message(STATUS "âš¡ Quantum JIT: ENABLED")
    message(STATUS "ğŸ”¥ Hyper GC: ENABLED")
    message(STATUS "ğŸš€ Ultra Parser: ENABLED")
    message(STATUS "ğŸŒŸ World Class Engine: ENABLED")
endif()

message(STATUS "ğŸ‰ Ready to build the world's most advanced JavaScript engine!")
message(STATUS "ğŸ† Destination: World's #1 JavaScript Engine")

# === ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è¨­å®š ===
install(TARGETS AeroJSCore
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
    RUNTIME DESTINATION bin
)

install(FILES ${WORLD_CLASS_HEADERS}
    DESTINATION include/aerojs
)

install(TARGETS world_class_test ultimate_test test_aerojs
    RUNTIME DESTINATION bin
)

# === ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¨­å®š ===
set(CPACK_PACKAGE_NAME "AeroJS")
set(CPACK_PACKAGE_VERSION "${PROJECT_VERSION}")
set(CPACK_PACKAGE_DESCRIPTION_SUMMARY "World's Most Advanced JavaScript Engine")
set(CPACK_PACKAGE_VENDOR "AeroJS Team")
set(CPACK_PACKAGE_CONTACT "team@aerojs.org")

include(CPack)
